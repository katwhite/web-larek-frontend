# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```

## Данные и типы данных, используемые в приложении

Карточка товара

```
export interface IProduct {
    id: string;
    title: string;
    description: string;
    category: string;
    price: number;
    image: string;
}
```

Модель для хранения каталога карточек

```
export interface ICardsData {
	cards: IProduct[];
	preview: string | null;
	getCard(cardId: string): IProduct;
}
```

Модель для хранения списка покупок в корзине
```
export interface IBasketModel {
    items: IBasketItem[];
    add(product: IProduct): void;
    remove(id: string, price: number): void;
}
```

Данные карточки, отображаемые в корзине

```
export type IBasketItem = Pick<ICard, '_id' | 'title' | 'price'>;
```

Формы заказа получают следующие данные
```
export interface IOrderForm {
    email: string;
    phone: string;
    address: string;
    payment: string;
}
```

Данные, которые нужно отобразить при успешном заказе
```
export interface IOrderResult {
    price: number;
}
```

Данные, отправляемые на сервер при заказе
```
export interface IOrder extends IOrderForm {
    items: string[],
    total: number
}
```

Тип видов оплаты
```
export type Payment = 'cash' | 'card';
```

## Архитектура приложения

Код разделён на слои согласно парадигме MVP:
- слой представления - отвечает за отображение данных
- слой данных - отвечает за хранение и изменение данных
- презентер - связавает представление и данные

## Базовый код

#### Класс Api

Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов. 
Методы:
- `get` - выполняет GЕТ запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер
- `post` - принимает объект с данными, которые будут переданы в JЅОN в теле запроса, и отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняется `РОЅT` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

#### Класс EventEmitter

Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. 
Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.Основные методы, реализуемые классом описаны интерфейсом `IEvents`:
- `оn` - подписка на событие
- `emit` - инициализация события
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие

### Слой данных

#### Класс LarekApi

Расширяет Api. В конструктор добавляется базовый url для загрузки контента.\
Методы:
- `getProductList(): Promise<IProduct[]>` - возвращает промис с массивом всех товаров
- `orderProducts(order: IOrder): Promise<IOrderResult>` - отправляет заказ на сервер

#### Класс CardsData

Отвечает за хранение и обновление данных карточек\
Конструктор класса принимает инстант брокера событий\
В полях класса хранятся:
- `_cards: IProduct[]` - массив объектов карточек
- `_preview: string | null` - айди карточки, выбранной для просмотра в модалке
- `events: IEvents` - экземпляр EventEmitter'а для работы с событиями

Методы для взаимодействия с данными:
сеттер и геттер массива карточек и превью
- `getCard(cardId: string): ICard` - возвращает карточку по её айди

#### Класс BasketModel

Отвечает за хранение списка покупок.\
Конструктор принимает брокер событий.\
Поля класса:
- `items: IBasketItem[]` - массив объектов карточек

Есть геттер и сеттер общей стоимости и методы:
- `add(product: IProduct): void` - добавляет товар в корзину, меняет стоимость
- `remove(id: string, price: number): void` - удаляет товар из корзины, меняет стоимость
- `clearBasket(): void` - очищает корзину

#### Класс UserModel

Отвечает за хранение и изменение данных пользователя.\
Имеет поля:
- `email`
- `phone`
- `address`
- `payment`
И методы:
- `changePayment(payment: Payment)`
- `changeAddress(address: string)`
- `changePhone(phone: string)`
- `changeEmail(email: string)` - для изменений соответствующих полей
- `isPayment(x: string): x is Payment` - метод для проверки на принадлежность типу оплаты
- `clearUserInfo()` - обнуляет данные
- `validateOrder()` - метод валидации данных, получаемых из форм

### Слой представления

#### Абстрактный класс Component

Является дженериком, отвечает за отображение базового компонента и является родителем всех классов представления. В конструктор принимает селектор контейнера, в женерик принимает тип объекта, передаёт этот тип в метод `render`.\
Имеет методы для работы с HTML:
- `toggleClass(element: HTMLElement, className: string, force?: boolean)` - убирает или добавляет класс элементу
- `setText(element: HTMLElement, value: unknown)` - устанавливает текстовое содержимое элемента
- `setDisabled(element: HTMLElement, state: boolean)` - блокирует и разблокирует элемент
- `setHidden(element: HTMLElement)` - скрывает элемент
- `setVisible(element: HTMLElement)` - показывает элемент
- `setImage(element: HTMLImageElement, src: string, alt?: string)` - устанавливает изображение
- `render` - возвращает корневой дом элемент (например, карточку)

#### Класс Page

Расширяет Component. Отвечает за отрисовку страницы. Принимает контейнер и брокер событий в конструктор. Имеет поля:
- `_counter: HTMLElement` - счётчик покупок
- `_catalog: HTMLElement` - обёртка для каталога карточек
- `_wrapper: HTMLElement` - обёртка всей страницы
- `_basket: HTMLElement` - корзина

Имеет сеттер счётчика, каталога, и блокировки страницы (boolean) при открытии модального окна.\
В `render` принимает объект, ключ - контейнер. Например: `page.render({catalog: cardsArray})`

#### Класс Card

Расширяет Component. Отвечает за отображение одной карточки в любом виде. В конструктор передаётся брокер событий и темплейт.\
Поля:
- `id`, `title`, `price` - обязательные поля
- `category`, `image`, `description` - необязательные поля

Есть геттер id, который возвращает id карточки, и сеттеры остальных полей, которые используются для быстрого апдейта информации.\
В `render` принимает объект карточки в виде `data: Partial<IProduct>`, и если есть категория, отображает её в соответствии с массивом css-классов.

#### Класс Basket

Отвечает за отображение корзины со списком покупок.\
Конструктор принимает DOM элемент списка по селектору и брокер событий.\
Поля класса:
- `protected _list: HTMLElement` - элемент списка
- `protected _total: HTMLElement` - элемент общей стоимости
- `protected _button: HTMLElement` - элемент кнопки открытия формы заказа

На все эти поля есть сеттеры.

#### Класс Modal

Расширяет Component. Отвечает за отображение модального окна, имеет слушатели для закрытия на оверлее по клику и на кнопке крестика по клику
Конструктор принимает селектор и брокер событий

Имеет поля:
- `protected _closeButton: HTMLButtonElement`
- `protected _content: HTMLElement`

Так же сеттер контента, который мы передаём в метод `render`, и методы:
- `open(): void`
- `close(): void`

#### Класс Form

Расширяет Component. Отвечает за отображение элементов формы\
Конструктор принимает контейнер и инстант брокера событий\
В полях класса хранятся:
- `button: HTMLButtonElement` - кнопка перехода на следующее окно
- `errors: HTMLElement` - элемент для вывода ошибок валидации

Метод для проверки корректности введённых данных:
- `checkValidation(data: Record<keyof IOrderForm, string>): boolean`
- `onInputChange(field: keyof T, value: string)`

#### Класс OrderForm

Расширяет Form. Имеет сеттеры address, payment.

#### Класс ContactsForm

Расширяет Form. Имеет сеттеры email, phone.

#### Класс Success

Расширяет Component. Имеет метод `setTotal`, в котором в текст вставляется сумма, полученная из апи при заказе.

### Слой коммуникации

`index.ts` выполняет роль презентера. В нём создаются экземпляры классов, затем настраивается обработка событий\
#### *Список возможных событий:*
*События изменения данных:*
- `initialData:loaded` - загрузка карточек из апи
- `basket:changed` - изменение списка карточек
- `card:add` - добавление карточки в корзину (изменяется кнопка на отображении карточки и список покупок)
- `card:delete` - удаление карточки из корзины

*События взаимодействия с интерфейсом:*
- `basket:changed` - событие изменения содержимого корзины
- `basket:open` - открытие модального окна с корзиной
- `order:open` - открытие модального окна с формой адреса при нажатии кнопки "оформить"
- `order:submit` - открытие модального окна с формой средств связи при нажатии кнопки "далее"
- `contacts:submit` - отправка формы и открытие модального окна с подтверждением заказа при нажатии кнопки "оплатить"
- `modal:open` - событие открытия модального окна
- `modal:close` - событие закрытия модального окна
- `card:select` - выбор карточки для открытия в модальном окне
- `email/phone/payment/address: changed` - событие, говорящее что соответствующие данные записаны в модель
- `[имя формы].email/phone/payment/address: change` - событие при изменении соответствующих полей в формах
- `formErrors:change` - событие валидации данных